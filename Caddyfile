{
    # Security: Disable the admin API
    admin off
}

:80 {
    # Logging (Global for this server block)
    log {
        output file /data/access.log {
            roll_size 10mb     # Rotate after file reaches 10MB
            roll_keep 10       # Keep only the last 10 rotated files
        }
        format json
    }

    # Main Logic: Only strictly matches paths starting with /ai-router/
    # handle_path strips the prefix from the request before processing content inside
    handle_path /ai-router/* {
        
        # 1. Health check (Public)
        # Effectively matches: /ai-router/health
        handle /health {
            reverse_proxy bifrost:8080
        }

        # 2. LLM Interactions (Public)
        # Effectively matches: /ai-router/v1*
        handle /v1* {
            reverse_proxy bifrost:8080
        }

        # 3. Admin & Governance (Secured by Basic Auth)
        # Catch-all for everything else under /ai-router/
        handle {
            basic_auth {
                {$ADMIN_USER} {$ADMIN_PASS_HASH}
            }
            reverse_proxy bifrost:8080
        }
    }

    # Fallback: Handle requests that do NOT start with /ai-router/
    handle {
        respond "Not Found" 404
    }
}